name: 构建APK

permissions:
  contents: write
  pull-requests: write
  actions: read
  packages: write

on:
  # 推送到主分支时自动构建
  push:
    branches: [ main, master ]
    paths:
      - 'lib/**'
      - 'android/**'
      - 'pubspec.yaml'
      - '.github/workflows/build-apk.yml'
  
  # 拉取请求时构建
  pull_request:
    branches: [ main, master ]
    paths:
      - 'lib/**'
      - 'android/**'
      - 'pubspec.yaml'
  
  # 手动触发
  workflow_dispatch:
    inputs:
      build_type:
        description: '构建类型'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release
      flutter_channel:
        description: 'Flutter渠道'
        required: true
        default: 'stable'
        type: choice
        options:
          - stable
          - beta
          - dev
      java_version:
        description: 'Java版本'
        required: true
        default: '17'
        type: choice
        options:
          - '11'
          - '17'
          - '21'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 设置Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.22.0'  # 指定具体版本更稳定
        channel: ${{ github.event.inputs.flutter_channel || 'stable' }}
        cache: true

    - name: 设置Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: ${{ github.event.inputs.java_version || '17' }}

    - name: 检查Flutter环境
      run: |
        flutter --version
        flutter doctor

    - name: 接受Android许可证
      run: |
        yes | sdkmanager --licenses || true
        flutter doctor --android-licenses

    - name: 获取依赖
      run: |
        flutter pub get
        echo "=== 依赖安装完成 ==="

    - name: 分析代码
      run: |
        flutter analyze
        echo "=== 代码分析完成 ==="

    - name: 运行测试
      run: |
        if [ -d "test" ] && [ "$(ls -A test)" ]; then
          flutter test
          echo "=== 测试完成 ==="
        else
          echo "没有找到测试文件，跳过测试"
        fi

    - name: 设置签名配置（仅Release构建）
      if: ${{ github.event.inputs.build_type == 'release' || github.event_name == 'push' }}
      run: |
        echo "=== 配置Android签名 ==="
        
        # 检查必要的secrets是否存在
        if [ -n "${{ secrets.KEYSTORE_FILE }}" ] && [ -n "${{ secrets.KEYSTORE_PASSWORD }}" ] && [ -n "${{ secrets.KEY_ALIAS }}" ] && [ -n "${{ secrets.KEY_PASSWORD }}" ]; then
          echo "所有签名secrets已配置"
          
          # 创建密钥库文件
          echo "${{ secrets.KEYSTORE_FILE }}" | base64 -d > android/app/release.keystore
          
          # 创建key.properties文件
          cat > android/key.properties << EOF
          storeFile=release.keystore
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          EOF
          
          echo "签名配置完成"
        else
          echo "警告: 签名secrets未完全配置，将使用debug签名"
        fi

    - name: 清理构建缓存
      run: |
        flutter clean
        flutter pub get

    - name: 构建APK
      id: build_apk
      run: |
        # 确定构建类型
        if [ "${{ github.event.inputs.build_type }}" = "release" ] || [ "${{ github.event_name }}" = "push" ]; then
          BUILD_TYPE="release"
          BUILD_ARGS="--release"
        else
          BUILD_TYPE="debug"
          BUILD_ARGS="--debug"
        fi
        
        echo "开始构建 $BUILD_TYPE APK..."
        
        flutter build apk $BUILD_ARGS
        
        echo "=== APK构建完成 ==="
        
        # 设置输出
        APK_PATH="build/app/outputs/flutter-apk/app-$BUILD_TYPE.apk"
        echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
        echo "build_type=$BUILD_TYPE" >> $GITHUB_OUTPUT

    - name: 上传APK构建产物
      uses: actions/upload-artifact@v4
      with:
        name: flclash-browser-${{ steps.build_apk.outputs.build_type }}-apk
        path: ${{ steps.build_apk.outputs.apk_path }}
        retention-days: 30

    - name: 生成构建信息
      run: |
        BUILD_TIME=$(date '+%Y-%m-%d %H:%M:%S')
        BUILD_COMMIT=$(git rev-parse --short HEAD)
        BUILD_BRANCH=${GITHUB_REF#refs/heads/}
        FLUTTER_VERSION=$(flutter --version | head -1)
        
        cat > build_info.txt << EOF
        构建时间: $BUILD_TIME
        构建分支: $BUILD_BRANCH
        提交哈希: $BUILD_COMMIT
        Flutter版本: $FLUTTER_VERSION
        构建类型: ${{ steps.build_apk.outputs.build_type }}
        GitHub Run: $GITHUB_RUN_ID
        EOF
        
        echo "=== 构建信息 ==="
        cat build_info.txt

    - name: 上传构建信息
      uses: actions/upload-artifact@v4
      with:
        name: flclash-browser-build-info
        path: build_info.txt
        retention-days: 30

    - name: 部署到GitHub Releases（仅release构建和push事件）
      if: ${{ steps.build_apk.outputs.build_type == 'release' && github.event_name == 'push' }}
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ steps.build_apk.outputs.apk_path }}
        body: |
          FlClash Browser APK Release Build
          
          构建信息：
          - 构建时间: $(date '+%Y-%m-%d %H:%M:%S')
          - 构建分支: ${GITHUB_REF#refs/heads/}
          - 提交哈希: ${{ github.sha }}
          - Flutter版本: $(flutter --version | head -1)
          
          请下载APK文件进行安装。
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: 失败时显示详细日志
      if: failure()
      run: |
        echo "=== 构建失败，显示环境信息 ==="
        echo "Flutter doctor详细信息:"
        flutter doctor -v
        echo ""
        echo "Java版本:"
        java -version
        echo ""
        echo "Android环境:"
        echo "ANDROID_HOME: $ANDROID_HOME"
        echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
